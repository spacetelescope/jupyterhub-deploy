#! /bin/bash

set -eu

# Export the intended (vs. as-built) conda environments as fully versioned
# (frozen) environment specifications.  These specs often require tweaking
# despite their origin from successfully built systems.  These specs originate
# inside a fully built container but become specs for frozen environments in
# the Docker source tree.  Nominally this is run when USE_FROZEN=0 and an
# environment is being resolved from loosely specified version requirements.

cd $IMAGE_DIR

mkdir -p environments/frozen

envs=$(find environments -name 'requirements.yml' | cut -d '/' -f 2)

for env in $envs; do
    if [ -f environments/${env}/requirements.yml ]; then
        echo "Dumping pip-tools requirements.txt and requirements.yml for ${env}"
        image-cp  /opt/environments/${env}/requirements.yml  environments/${env}
        image-cp  /opt/environments/${env}/requirements.txt  environments/${env}
    fi
    echo "Dumping conda export versions for ${env}"
    image-env-export $env  > environments/frozen/${env}-frozen.yml
done
