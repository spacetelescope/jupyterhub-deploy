#! /bin/bash

set -eu

# Export the fully specified versions of packages from the as-built
# image for use with USE_FROZEN=1.  Exported files are either
# copied/generated from a running container and then added to git
# sources for future builds.

list_dirs() {
    # list the directories at $root_dir defaulting to .

    root_dir=${1:-.}

    find $root_dir -maxdepth 1 -type d | grep '/' | cut -d '/' -f2
}

cd $IMAGE_DIR

# pip-tools frozen requirements are stored at /opt/envs-frozen
# copy /opt/envs-frozen  to env-frozen in the Docker sources mission dir.
# rm -rf env-frozen
image-cp /opt/env-frozen

# mkdir -p environments/frozen

# # original frozen requirements are dumped dynamically for each env
# for env in `list_dirs environments | grep -v frozen`; do
#     if [[ ! -z "$env" ]]; then
#         echo "Dumping conda export versions for ${env}"
#         image-env-export $env  > environments/frozen/${env}-frozen.yml
#     fi
# done
